machine:
  services:
    - docker
  node:
    version: 6.3.0

general:
  branches:
    ignore:
      - gh-pages

test:
  post:
    - cat ./coverage/lcov.info | ./node_modules/.bin/coveralls --verbose
    - >
      if [ -n "${RUN_UPDATE}" ]; then
        docker run -v /home/ubuntu/verif.site/import/../data:/data -v /home/ubuntu/verif.site/import/../results:/home/scanner/results betagouv/domain-scan /data/sites.csv --scan=inspect,sslyze,tls,pageload --force
        npm run update;
      fi

deployment:
  production:
    branch: master
    commands:
      - git config --global user.email "infra@beta.gouv.fr"
      - git config --global user.name "CircleCI"
      - npm run deploy
